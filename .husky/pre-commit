#!/usr/bin/env sh

# Run lint-staged for formatting and linting
npx lint-staged

# Run type checking
echo "Running type check..."
npm run type-check

# Run unit tests for changed files
echo "Running tests for changed files..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | tr '\n' ' ')
if [ -n "$STAGED_FILES" ]; then
  npm test -- --findRelatedTests $STAGED_FILES --passWithNoTests
else
  echo "No TypeScript files staged, skipping tests"
fi

# Check for console.log statements in staged app code (exclude scripts and config)
echo "Checking for console.log statements in src/..."
STAGED_APP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^src/.*\.(ts|tsx|js|jsx)$' || true)

if [ -n "$STAGED_APP_FILES" ]; then
  # grep returns 0 if a match is found, 1 if no match, 2 on error
  if grep -n "console.log" $STAGED_APP_FILES >/dev/null 2>&1; then
    echo "Error: Found console.log statements in staged files"
    grep -n "console.log" $STAGED_APP_FILES || true
    echo "Please remove console.log statements before committing"
    exit 1
  fi
fi

echo "Pre-commit checks passed âœ…"